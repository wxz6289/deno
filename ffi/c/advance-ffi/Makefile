# Makefile for building shared library from add.c

# æ£€æµ‹æ“ä½œç³»ç»Ÿ
UNAME_S := $(shell uname -s)

# æ ¹æ®æ“ä½œç³»ç»Ÿè®¾ç½®å˜é‡
ifeq ($(UNAME_S),Darwin)
    # macOS
    LIB_EXT = dylib
    ADD_LIB = libadd.$(LIB_EXT)
    ADV_LIB = libadvanced.$(LIB_EXT)
    CC_FLAGS = -shared -fPIC
else ifeq ($(UNAME_S),Linux)
    # Linux
    LIB_EXT = so
    ADD_LIB = libadd.$(LIB_EXT)
    ADV_LIB = libadvanced.$(LIB_EXT)
    CC_FLAGS = -shared -fPIC
else
    # Windows (å‡è®¾ä½¿ç”¨ MinGW)
    LIB_EXT = dll
    ADD_LIB = add.$(LIB_EXT)
    ADV_LIB = advanced.$(LIB_EXT)
    CC_FLAGS = -shared
endif

# ç¼–è¯‘å™¨å’Œæºæ–‡ä»¶
CC = gcc
ADD_SRC = add.c
ADV_SRC = advanced.c

# é»˜è®¤ç›®æ ‡
all: $(ADD_LIB) $(ADV_LIB)

# ç¼–è¯‘åŸºç¡€å…±äº«åº“
$(ADD_LIB): $(ADD_SRC)
	@echo "ğŸ”¨ ç¼–è¯‘ $(ADD_SRC) ä¸º $(ADD_LIB)..."
	$(CC) $(CC_FLAGS) -o $(ADD_LIB) $(ADD_SRC)
	@echo "âœ… ç¼–è¯‘å®Œæˆ: $(ADD_LIB)"

# ç¼–è¯‘é«˜çº§å…±äº«åº“
$(ADV_LIB): $(ADV_SRC)
	@echo "ğŸ”¨ ç¼–è¯‘ $(ADV_SRC) ä¸º $(ADV_LIB)..."
	$(CC) $(CC_FLAGS) -o $(ADV_LIB) $(ADV_SRC)
	@echo "âœ… ç¼–è¯‘å®Œæˆ: $(ADV_LIB)"

# å•ç‹¬ç¼–è¯‘ç›®æ ‡
basic: $(ADD_LIB)
advanced: $(ADV_LIB)

# æµ‹è¯•åŸºç¡€ FFI
test-basic: $(ADD_LIB)
	@echo "ğŸ§ª è¿è¡ŒåŸºç¡€ FFI æµ‹è¯•..."
	deno run --allow-ffi ffi-add.ts

# æµ‹è¯•é«˜çº§ FFI
test-advanced: $(ADV_LIB)
	@echo "ğŸ§ª è¿è¡Œé«˜çº§ FFI æµ‹è¯•..."
	deno run --allow-ffi advanced-ffi.ts

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test: test-basic test-advanced

# æŸ¥çœ‹ç¬¦å·è¡¨
symbols: $(ADD_LIB) $(ADV_LIB)
	@echo "ğŸ” æŸ¥çœ‹åŸºç¡€åº“ç¬¦å·è¡¨:"
ifeq ($(UNAME_S),Darwin)
	nm -gU $(ADD_LIB)
	@echo ""
	@echo "ğŸ” æŸ¥çœ‹é«˜çº§åº“ç¬¦å·è¡¨:"
	nm -gU $(ADV_LIB)
else ifeq ($(UNAME_S),Linux)
	nm -D $(ADD_LIB)
	@echo ""
	@echo "ğŸ” æŸ¥çœ‹é«˜çº§åº“ç¬¦å·è¡¨:"
	nm -D $(ADV_LIB)
else
	@echo "Windows ç³»ç»Ÿè¯·ä½¿ç”¨:"
	@echo "  objdump -T $(ADD_LIB)"
	@echo "  objdump -T $(ADV_LIB)"
endif

# æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶..."
	rm -f *.so *.dylib *.dll
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
help:
	@echo "å¯ç”¨çš„ make ç›®æ ‡:"
	@echo "  all          - ç¼–è¯‘æ‰€æœ‰å…±äº«åº“ (é»˜è®¤)"
	@echo "  basic        - ç¼–è¯‘åŸºç¡€å…±äº«åº“"
	@echo "  advanced     - ç¼–è¯‘é«˜çº§å…±äº«åº“"
	@echo "  test-basic   - ç¼–è¯‘å¹¶è¿è¡ŒåŸºç¡€ FFI æµ‹è¯•"
	@echo "  test-advanced- ç¼–è¯‘å¹¶è¿è¡Œé«˜çº§ FFI æµ‹è¯•"
	@echo "  test         - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  symbols      - æŸ¥çœ‹å…±äº«åº“çš„ç¬¦å·è¡¨"
	@echo "  clean        - æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶"
	@echo "  help         - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"

# å£°æ˜ä¼ªç›®æ ‡
.PHONY: all basic advanced test-basic test-advanced test symbols clean help